{% extends "base.html" %} {% block title %}{% if diary %}ç¼–è¾‘æ—¥è®°{% else
%}æ–°å»ºæ—¥è®°{% endif %} - æ¯æ—¥åæ€æ—¥è®°{% endblock %} {% block head %}
<!-- å¼•å…¥å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ Summernote -->
<link
  href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.css"
  rel="stylesheet"
/>
<style>
  .form-group {
    margin-bottom: 1.5rem;
  }
  .quote-textarea {
    min-height: 100px;
  }
  .note-editor {
    margin-bottom: 1.5rem;
  }
</style>
{% endblock %} {% block content %}
<div class="card">
  <div class="card-header bg-primary text-white">
    <h5 class="mb-0">
      {% if diary %}
      <i class="fas fa-edit me-2"></i>ç¼–è¾‘æ—¥è®° {% else %}
      <i class="fas fa-plus-circle me-2"></i>æ–°å»ºæ—¥è®° {% endif %}
    </h5>
  </div>
  <div class="card-body">
    <form id="diaryForm">
      {% if diary %}
      <input type="hidden" name="diary_id" value="{{ diary.id }}" />
      <input type="hidden" name="date" value="{{ diary.date }}" />
      {% endif %}

      <div class="row">
        <!-- æ—¥æœŸæ˜¾ç¤º -->
        <div class="col-12 mb-3">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="text-muted">
              {% if diary %} {{ diary.date }} {% else %} ä»Šå¤© ({{ current_date()
              }}) {% endif %}
            </h5>
          </div>
        </div>

        <!-- å¤©æ°”å’Œå¿ƒæƒ… -->
        <div class="col-md-6">
          <div class="form-group">
            <label for="weather" class="form-label">ä»Šæ—¥å¤©æ°”</label>
            <input
              type="text"
              class="form-control"
              id="weather"
              name="weather"
              placeholder="å¦‚: ğŸŒ¤ï¸"
              value="{{ diary.weather if diary else '' }}"
            />
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-group">
            <label for="mood" class="form-label">ä»Šæ—¥å¿ƒæƒ…</label>
            <input
              type="text"
              class="form-control"
              id="mood"
              name="mood"
              placeholder="å¦‚: æ„‰å¿«"
              value="{{ diary.mood if diary else '' }}"
            />
          </div>
        </div>

        <!-- æ ‡é¢˜ -->
        <div class="col-12">
          <div class="form-group">
            <label for="title" class="form-label">æ ‡é¢˜</label>
            <input
              type="text"
              class="form-control"
              id="title"
              name="title"
              placeholder="è¯·è¾“å…¥æ—¥è®°æ ‡é¢˜"
              value="{{ diary.title if diary else '' }}"
              required
            />
          </div>
        </div>

        <!-- ä»Šæ—¥è¯­å½• - ä½¿ç”¨æ›´å¤§çš„æ–‡æœ¬æ¡† -->
        <div class="col-12">
          <div class="form-group">
            <label for="quote" class="form-label">ä»Šæ—¥è¯­å½•</label>
            <textarea
              class="form-control quote-textarea"
              id="quote"
              name="quote"
              placeholder="ä»Šæ—¥æ ¼è¨€æˆ–æ„Ÿæ‚Ÿ"
            >
{{ diary.quote if diary else '' }}</textarea
            >
          </div>
        </div>

        <!-- å†…å®¹ -->
        <div class="col-12">
          <div class="form-group">
            <label for="content" class="form-label">å†…å®¹</label>
            <textarea class="form-control" id="content" name="content" required>
{{ diary.content if diary else '' }}</textarea
            >
          </div>
        </div>

        <!-- æŒ‰é’® -->
        <div class="col-12 text-end">
          <a href="{{ url_for('index') }}" class="btn btn-secondary">
            <i class="fas fa-times me-1"></i>å–æ¶ˆ
          </a>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-1"></i>ä¿å­˜
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %} {% block scripts %}
<!-- å¼•å…¥å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ Summernote JS -->
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/lang/summernote-zh-CN.min.js"></script>
<script>
  $(document).ready(function () {
    // åˆå§‹åŒ–å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
    $("#content").summernote({
      lang: "zh-CN",
      height: 300,
      toolbar: [
        ["style", ["style"]],
        ["font", ["bold", "underline", "italic", "clear"]],
        ["color", ["color"]],
        ["para", ["ul", "ol", "paragraph"]],
        ["table", ["table"]],
        ["insert", ["link"]],
        ["view", ["fullscreen", "codeview", "help"]],
      ],
      placeholder: "è¯·è¾“å…¥æ—¥è®°å†…å®¹...",
    });

    // è¡¨å•æäº¤
    $("#diaryForm").submit(function (e) {
      e.preventDefault();
      console.log("å¼€å§‹æäº¤è¡¨å•");

      // è·å–å¯Œæ–‡æœ¬ç¼–è¾‘å™¨çš„å†…å®¹
      var content = $("#content").summernote("code");
      console.log("å¯Œæ–‡æœ¬å†…å®¹:", content); // æ·»åŠ æ—¥å¿—

      // è·å–è¡¨å•æ•°æ®
      var formData = new FormData(this);

      // æ›´æ–°contentå­—æ®µ
      formData.set("content", content);

      // æ‰“å°è¡¨å•æ•°æ®
      for (var pair of formData.entries()) {
        console.log(pair[0] + ": " + pair[1]);
      }

      // æäº¤åˆ°æœåŠ¡å™¨
      $.ajax({
        url: "{{ url_for('save_diary') }}",
        type: "POST",
        data: formData,
        processData: false,
        contentType: false,
        success: function (response) {
          console.log("æœåŠ¡å™¨å“åº”:", response);
          if (response.success) {
            alert(response.message);
            // ä¿®æ”¹è·³è½¬é€»è¾‘
            try {
              console.log("å‡†å¤‡è·³è½¬åˆ°é¦–é¡µ");
              var indexUrl = "{{ url_for('index') }}";
              console.log("é¦–é¡µURL:", indexUrl);
              window.location.href = indexUrl;
            } catch (e) {
              console.error("è·³è½¬å¤±è´¥:", e);
              // ä½¿ç”¨æ™®é€šé“¾æ¥æ–¹å¼è·³è½¬
              window.location = "/";
            }
          } else {
            alert("ä¿å­˜å¤±è´¥: " + response.message);
          }
        },
        error: function (xhr, status, error) {
          console.error("AJAXé”™è¯¯:", status, error);
          console.error("å“åº”æ–‡æœ¬:", xhr.responseText);
          alert("æäº¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯");
        },
      });
    });
  });
</script>
{% endblock %}
